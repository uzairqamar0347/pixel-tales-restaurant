<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Tales</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <!-- Supabase library is correctly placed here -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* A light, clean background */
            color: #2d3748;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }
        html {
            scroll-behavior: smooth;
        }
        .menu-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .category-btn {
    transition: all 0.2s ease-in-out;
}
.category-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            overflow: auto;
        }
        .modal-content {
            position: relative;
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            animation-name: animatetop;
            animation-duration: 0.4s;
        }
        #receipt-container {
    z-index: 110; /* Higher than the cart modal's 100 */
}
#congrats-modal {
    z-index: 120; /* Even higher, for the final pop-up */
}
        @keyframes animatetop {
            from { top: -300px; opacity: 0; }
            to { top: 0; opacity: 1; }
        }

        /* Red textured background for the menu section */
       #menu {
    background-color: black;
    }
    
.fade-in-up {
    animation: fadeInUp 1s ease-out forwards;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
#hero {
        background-image: url('https://michaelfoods.com/wp-content/uploads/holy-chips-hero-desktop-fixed.jpg?semt=ais_hybrid&w=740&q=80?q=80&w=1920&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        height: 8 0vh;
    }
    @media (max-width: 768px) {
        #hero {
            height: 40vh;
        }
    }
    .quantity-btn-modern {
    background-color: #f3f4f6;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem
    width: 2rem;
    height: 2rem;
    font-weight: 600;
    color: #374151;
    transition: background-color 0.2s, color 0.2s, transform 0.2s;
    }
    .quantity-btn-modern:hover {
    background-color: #e5e7eb;
    color: #1f2937;
    transform: scale(1.1);
}
.quantity-btn-modern:hover {
    background-color: #e5e7eb;
    color: #1f2937;
}
.slide-in-down {
    animation: slideInDown 1s ease-out forwards;
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.size-selector {
    transition: max-height 0.2s ease-in-out, opacity 0.2s ease-in-out, padding 0.2s ease-in-out;
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    padding-top: 0;
    padding-bottom: 0;
}

.size-selector.selector-open {
    max-height: 500px;
    opacity: 1;
    padding-top: 1rem;
    padding-bottom: 1rem;
}
.confetti {
    position: fixed;
    top: 0;
    left: 0;
    width: 10px;
    height: 10px;
    background-color: #f59e0b; /* Default yellow */
    opacity: 0;
    z-index: 130; /* Just behind the modal's z-index of 100 */
    pointer-events: none; /* Make them unclickable */
    animation: fall 4s ease-out forwards;
}
@keyframes fall {
    0% {
        transform: translateY(-10vh) rotateZ(0deg);
        opacity: 1;
    }
    100% {
        transform: translateY(110vh) rotateZ(720deg);
        opacity: 0;
    }
}
.btn-success {
    background-color: #16a34a !important; /* A nice green color from Tailwind */
    color: white !important;
    cursor: default !important; /* Make it look non-clickable temporarily */
    transform: scale(1.05); /* Optional: a slight "pop" effect */
    transition: all 0.3s ease-in-out;
}
.sticky-cart-container {
    /* Hidden by default on all screens */
    display: none; 
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 90;
    padding: 1rem;
    background-color: #ea580c;
    color: white;
    box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
    cursor: pointer;
    transform: translateY(100%);
    transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
}
.sticky-cart-container.visible {
    transform: translateY(0%);
}
.pulse-btn {
    animation: pulse 2.5s infinite;
}
@media (max-width: 768px) {
    .sticky-cart-container {
        display: flex;
    }
}
@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.7);
    }
    50% {
        transform: scale(1.02);
        box-shadow: 0 0 0 10px rgba(234, 88, 12, 0);
    }
}
#receipt-print-container {
    position: absolute;
    left: -9999px; /* Position it way off-screen */
    top: 0;
    width: 500px; /* Give it a fixed, clean width */
    background-color: white;
    padding: 2rem;
    font-family: 'Inter', sans-serif;
    color: #2d3748;
}
#congrats-modal .modal-content {
    transform: scale(0.7);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease-in-out;
}

#congrats-modal.visible {
    display: flex;
}

#congrats-modal.visible .modal-content {
    transform: scale(1);
    opacity: 1;
}
.quantity-btn-brand {
    background-color: #f97316; /* Your brand orange */
    border: none;
    border-radius: 0.5rem; /* Rounded square */
    width: 1.75rem; /* 28px */
    height: 1.75rem; /* 28px */
    font-weight: 600;
    color: white;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease-in-out;
}

.quantity-btn-brand:hover {
    background-color: #ea580c; /* A darker orange */
    transform: scale(1.05);
}
.size-chip-container {
    display: flex;
    justify-content: space-around;
    gap: 0.5rem; /* A smaller gap for when they are close */
    margin-bottom: 1rem;
    padding: 0 0.1rem; /* Add a little horizontal padding */
}

.size-chip {
    border: 2px solid #e5e7eb; /* light gray */
    background-color: #ffffff;
    color: #374151; /* dark gray */
    border-radius: 9999px; /* pill shape */
    padding: 0.5rem 1.25rem; /* vertical | horizontal */
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.size-chip:hover {
    border-color: #fb923c; /* light orange */
}

.size-chip.selected {
    background-color: #f97316; /* brand orange */
    color: #ffffff;
    border-color: #f97316;
}

.size-price-display {
    text-align: center;
    font-size: 1.25rem; /* 20px */
    font-weight: 700;
    color: #f59e0b; /* amber-500 */
    margin-bottom: 1.5rem;
    height: 2rem; /* Reserve space to prevent layout shift */
    transition: opacity 0.2s ease-in-out;
}
.size-radio-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem; /* 12px */
}
.size-radio-group input[type="radio"] {
    opacity: 0;
    position: fixed;
    width: 0;
}
.size-radio-group label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background-color: #f3f4f6; /* light gray */
    border: 2px solid transparent;
    border-radius: 0.75rem; /* 12px */
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
.size-radio-group label:hover {
    border-color: #fb923c; /* light orange */
}

.size-radio-group input[type="radio"]:checked + label {
    background-color: #fff7ed; /* extra light orange */
    border-color: #f97316; /* brand orange */
    color: #c2410c; /* dark orange text */
    font-weight: 700;
}
.quantity-btn-outline {
    background-color: transparent; border: 2px solid #e5e7eb; border-radius: 0.5rem;
    width: 3rem; height: 3rem; font-weight: 600; color: #6b7280;
    transition: all 0.2s ease-in-out;
}
.quantity-btn-outline:hover { background-color: #f9fafb; border-color: #f97316; color: #f97316; }

/* Contained Card Accordion Styling (for add-ons) */
.addon-accordion-card { background-color: #f3f4f6; border-radius: 0.75rem; overflow: hidden; transition: all 0.3s ease-in-out; }
.addon-accordion-card .addon-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; cursor: pointer; font-weight: 600; }
.addon-accordion-card .addon-header .optional-text { font-size: 0.875rem; font-weight: 400; color: #6b7280; }
.addon-accordion-card .addon-header .arrow-icon { transition: transform 0.3s ease-in-out; }
.addon-accordion-card .addon-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-in-out; }
.addon-accordion-card.open { background-color: #ffffff; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
.addon-accordion-card.open .addon-header { border-bottom: 1px solid #e5e7eb; }
.addon-accordion-card.open .arrow-icon { transform: rotate(180deg); }
.addon-accordion-card.open .addon-content { max-height: 500px; padding: 0 1rem 1rem 1rem; }
.addon-accordion {
    border-radius: 0.75rem;
    overflow: hidden;
    border: 1px solid #e5e7eb;
}

.addon-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background-color: #e53e3e; /* red-400 */
    color: white;
    cursor: pointer;
    font-weight: 600;
}

.addon-header .optional-text {
    font-size: 0.875rem;
    font-weight: 400;
    opacity: 0.8;
}

.addon-header .arrow-icon {
    transition: transform 0.3s ease-in-out;
}

.addon-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
    padding: 0 1rem;
    background-color: #f9fafb; /* gray-50 */
}

/* State when the accordion is open */
.addon-accordion.open .addon-header {
    background-color: #ef4444; /* red-500 */
}

.addon-accordion.open .arrow-icon {
    transform: rotate(180deg);
}

.addon-accordion.open .addon-content {
    max-height: 500px; /* A large value to allow content to expand */
    padding: 1rem;
}
.addon-accordion-card {
    background-color: #f3f4f6; /* light gray background */
    border-radius: 0.75rem; /* 12px */
    overflow: hidden;
    transition: all 0.3s ease-in-out;
}

.addon-accordion-card .addon-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    cursor: pointer;
        font-size: 0.8rem;
    font-weight: 600;
}

.addon-accordion-card .addon-header .optional-text {
    font-size: 0.7rem;
    font-weight: 400;
    color: #FFFFFF; /* medium gray */
}

.addon-accordion-card .addon-header .arrow-icon {
    transition: transform 0.3s ease-in-out;
}

.addon-accordion-card .addon-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}

.addon-accordion-card.open {
    background-color: #ffffff;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.addon-accordion-card.open .addon-header {
    border-bottom: 1px solid #e5e7eb;
}

.addon-accordion-card.open .arrow-icon {
    transform: rotate(180deg);
}

.addon-accordion-card.open .addon-content {
    max-height: 500px;
    padding: 0 1rem 1rem 1rem;
}
.status-ribbon-container {
    top: 0;
    left: 0;
    width: 100%;
    padding: 10px 0;
    z-index: 1000;
    overflow: hidden;
    white-space: nowrap;
    display: none;
}
.status-ribbon-container.visible {
    display: block;
}
.status-ribbon-container.open {
    background-color: #22c55e; /* Green */
    box-shadow: 0 2px 10px rgba(34, 197, 94, 0.5);
}
.status-ribbon-container.closed {
    background-color: #ef4444; /* Red */
    box-shadow: 0 2px 10px rgba(239, 68, 68, 0.5);
}
.status-ribbon-content {
    display: inline-block;
    color: white;
    font-weight: 600;
    font-size: 1.1rem;
    animation: marquee 15s linear infinite;
}
.ribbon-text-segment:not(:last-child)::after {
    content: ' • '; /* This adds a bullet point divider */
    margin: 0 2em; /* Adds space around the divider */
}
.ribbon-divider {
    margin: 0 6em; /* Add space between the duplicated text */
}
@keyframes marquee {
    from {
        transform: translateX(0%);
    }
    to {
        transform: translateX(-50%); /* Move left by exactly half its width */
    }
}
.btn-disabled {
    background-color: #7f8c8d !important; /* A muted gray */
    cursor: not-allowed !important;
    opacity: 0.7;
}
.special-banner {
    background: linear-gradient(45deg, #f97316, #ea580c); /* Brand orange gradient */
    color: white;
    text-align: center;
    padding: 12px;
    font-weight: 700;
    font-size: 1.2rem;
    box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
    display: none; /* Hidden by default */
    align-items: center;
    justify-content: center;
    gap: 1rem;
}
.special-banner.visible {
    display: flex;
}

/* Sparkle animation for attention */
.sparkle {
    display: inline-block;
    animation: sparkle 1.5s ease-in-out infinite;
}
@keyframes sparkle {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.7; }
}
    </style>
</head>
<body class="antialiased"  >
    <!-- Navigation Bar -->
    <header class="bg-white shadow-sm sticky top-0 z-50"  >
        <nav class="container mx-auto px-6 py-2 flex justify-between items-center"  >
            <a href="#hero" class="text-6xl font-bold text-gray-800"  ><img src="https://img.freepik.com/premium-vector/burger-logo_1366-144.jpg" alt="Pixel Tales Logo" class="h-20"    ></a>
            <div class="space-x-4 flex items-center"  >
                <a href="#menu" class="text-gray-600 hover:text-orange-500 transition duration-300 hidden md:block"  >Menu</a>
                <a href="#about" class="text-gray-600 hover:text-orange-500 transition duration-300 hidden md:block"  >About Us</a>
                <a href="#contact" class="text-gray-600 hover:text-orange-500 transition duration-300 hidden md:block"  >Contact</a>
                <button id="cartButton" class="bg-orange-500 text-white font-semibold py-2 px-4 rounded-full shadow-lg hover:bg-orange-600 transition duration-300 relative pulse-btn"  >
                    Your Cart (<span id="cartCount">0</span>)
                </button>
            </div>
        </nav>
    </header>
    <div id="status-ribbon" class="status-ribbon-container hidden">
    <div class="status-ribbon-content">
        <span class="ribbon-text-segment"></span>
        <span class="ribbon-text-segment"></span>
        <span class="ribbon-text-segment"></span>
        <span class="ribbon-text-segment"></span>
        <span class="ribbon-text-segment"></span>
    </div>
</div>
    <section id="hero-slider" class="slide-in-down relative w-full h-[60vh] md:h-[70vh] overflow-hidden"  >
    <div id="slides-container" class="flex h-full transition-transform duration-700 ease-in-out">
        </div>
        <div class="w-full h-full flex-shrink-0 relative"  >
            </div>
        </div>

        <div class="w-full h-full flex-shrink-0 relative"  >
     
            </div>
        </div>
    </div>
    <div id="slider-dots" class="absolute bottom-5 left-1/2 -translate-x-1/2 flex space-x-3"  >
        </div>
</section>
<div id="special-banner" class="special-banner hidden">
        <span class="sparkle">✨</span>
        <span id="special-banner-text"></span>
        <span class="sparkle">✨</span>
    </div>
    <section id="menu" class="py-20 text-white"  >
    <div class="container mx-auto px-6"  >
        <h2 class="text-4xl font-bold text-center mb-12"  >Our Menu</h2>        
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-8"  >
          <div class="relative w-full sm:w-1/3 mb-4 sm:mb-0"  >
        <input type="text" id="search-bar" placeholder="Search for food..." class="w-full py-2 pl-10 pr-4 text-gray-800 bg-white rounded-full focus:outline-none focus:ring-2 focus:ring-orange-500"  >
 <div class="absolute inset-y-0 left-0 flex items-center pl-3"  >
            <i class="fas fa-search text-gray-400"  ></i>
        </div>
    </div>
            <div class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-4 sm:mb-0"  >
                    <button class="category-btn bg-white text-red-900 px-4 py-2 rounded-full font-semibold hover:bg-gray-100 transition duration-300" data-category="deals">Deals</button>
                <button class="category-btn bg-white text-red-900 px-4 py-2 rounded-full font-semibold hover:bg-gray-100 transition duration-300" data-category="pizza"  >Pizza</button>
                <button class="category-btn bg-white text-red-900 px-4 py-2 rounded-full font-semibold hover:bg-gray-100 transition duration-300" data-category="burgers">Burgers</button>
                <button class="category-btn bg-white text-red-900 px-4 py-2 rounded-full font-semibold hover:bg-gray-100 transition duration-300" data-category="side-dishes">Side Dishes</button>
                <button class="category-btn bg-white text-red-900 px-4 py-2 rounded-full font-semibold hover:bg-gray-100 transition duration-300" data-category="fries">Fries</button>
                <button class="category-btn bg-white text-red-900 px-4 py-2 rounded-full font-semibold hover:bg-gray-100 transition duration-300" data-category="beverages">Beverages</button>
                <button class="category-btn bg-white text-red-900 px-4 py-2 rounded-full font-semibold hover:bg-gray-100 transition duration-300" data-category="drinks">Drinks</button>
                <button class="category-btn bg-white text-red-900 px-4 py-2 rounded-full font-semibold hover:bg-gray-100 transition duration-300" data-category="desserts">Desserts</button>
            </div>
            <div class="relative inline-block text-left"  >
                <select id="sort-select" class="bg-white text-red-900 px-4 py-2 rounded-full font-semibold border-none focus:outline-none cursor-pointer block w-full bg-white border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded-full leading-tight focus:outline-none focus:bg-white focus:border-gray-500"  >
                    <option value="default"  >Default Sort</option>
                    <option value="price-asc"  >Price (Low to High)</option>
                    <option value="price-desc"  >Price (High to Low)</option>
                </select>
            </div>
        </div>
<div id="menu-items-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
    <p id="no-results-message" class="text-white text-center col-span-full hidden">No items match your search.</p>          
    </div>
</section>
<section id="recent-orders" class="py-20 bg-gray-100">
    <div class="container mx-auto px-6">
        <h2 class="text-4xl font-bold text-center mb-12 text-gray-800">Your Recent Orders</h2>
        <div id="recent-orders-container" class="max-w-4xl mx-auto space-y-4">
            <p class="text-center text-gray-500">You have no recent orders yet!</p>
        </div>
    </div>
</section>
    <!-- About Us Section -->
    <section id="about" class="relative py-20 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1695457209904-872bc81b3a5e?q=80&w=1032&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');" data-animation="fade-in-up"  >
        <div class="absolute inset-0 bg-black opacity-40 shadow-2xl"  ></div>
    <div class="container mx-auto px-6 text-center relative z-10"  >
        <h2 class="text-4xl text-white font-bold mb-8"  >Our Story</h2>
        <p class="text-lg text-white max-w-3xl mx-auto"  >
            Founded in 2025, Pixel Tales was born out of a passion for creating delicious, wholesome food using locally sourced ingredients. Our chefs are dedicated to crafting memorable dining experiences, one dish at a time. We believe that great food brings people together.
        </p>
    </div>
</section>
   <section id="contact" class="relative py-20 relative bg-cover bg-center" style="background-image: url('https://plus.unsplash.com/premium_photo-1695762436987-1cf827e5f1dd?q=80&w=872&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D ');" data-animation="fade-in-up"  >
    <div class="absolute inset-0 bg-black opacity-30 shadow-2xl"  ></div>
    <div class="container mx-auto px-6 text-center relative z-10"  >
        <h2 class="text-4xl font-bold mb-8 text-white"  >Contact Us</h2>
        <p class="text-lg text-white mb-6"  >Reach out to us through the following options:</p>
        <div class="grid grid-cols-2 gap-4 max-w-xl mx-auto"  >
            <a href="tel:+923460714042" class="bg-green-600 text-white font-semibold p-8 rounded-lg shadow-lg hover:bg-green-600 transition duration-300 flex flex-col items-center justify-center space-y-2"  >
                <i class="fas fa-phone-alt text-2xl"  ></i>
                <span>Call Us</span>
            </a>
            <a href="mailto:uzairqamar0347@gmail.com" class="bg-red-500 text-white font-semibold p-8 rounded-lg shadow-lg hover:bg-red-900 transition duration-300 flex flex-col items-center justify-center space-y-2"  >
                <i class="fas fa-envelope text-2xl"  ></i>
                <span>Email Us</span>
            </a>
            <a href="https://maps.google.com/?q=Nizami+Homeopathic+Clinic" target="_blank" class="bg-red-800 text-white font-semibold p-8 rounded-lg shadow-lg hover:bg-red-600 transition duration-300 flex flex-col items-center justify-center space-y-2"  >
                <i class="fas fa-map-marker-alt text-2xl"  ></i>
                <span>View on Map</span>
            </a>
            <a href="https://wa.me/923460714042" target="_blank" class="bg-green-700 text-white font-semibold p-8 rounded-lg shadow-lg hover:bg-green-700 transition duration-300 flex flex-col items-center justify-center space-y-2"  >
                <i class="fab fa-whatsapp text-2xl"  ></i>
                <span>WhatsApp</span>
            </a>
        </div>
    </div>
</section>
    <section id="location" class="relative py-10 relative" style="background-image: url('https://images.unsplash.com/photo-1662472460493-87a12773d731?q=80&w=870&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D'); background-size: cover; background-position: center;" data-animation="fade-in-up"  >
    <div class="absolute inset-0 bg-black opacity-50 shadow-2xl"  ></div>
    <div class="container mx-auto px-6 text-center text-white relative z-10"  >
        <h2 class="text-4xl font-bold mb-8"  >Find Us</h2>
        <p class="max-w-2xl mx-auto mb-10"  >Visit us at our location and enjoy our delicious food in person!</p>
        <div class="shadow-lg rounded-lg overflow-hidden relative bg-black bg-opacity-50" style="padding-bottom: 30%;"  >
            <iframe 
                src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d427.61975298537095!2d72.48847114709355!3d30.971653564902113!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x39230fb7e895ee79%3A0x14a5fbdc0f10eaf2!2sNizami%20Homeopathic%20clinic!5e0!3m2!1sen!2s!4v1755320626427!5m2!1sen!2s" 
                class="absolute inset-0 w-full h-full" 
                style="border:0;" 
                allowfullscreen="" 
                      loading="lazy"  <!-- ADD THIS LINE -->
                referrerpolicy="no-referrer-when-downgrade"
            ></iframe>
        </div>
    </div>
</section>
    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8"  >
      <div class="container mx-auto px-6 text-center"  >
                        <p>&copy; 2025 Pixel Tales. All Rights Reserved.</p>
            <div class="mt-4 space-x-4"  >
                <a href="#" class="hover:text-orange-500 transition duration-300"  >Privacy Policy</a>
                <a href="#" class="hover:text-orange-500 transition duration-300"  >Terms of Service</a>
            </div>
        </div>
    </footer>
    <!-- Cart Modal -->
    <div id="cartModal" class="modal"  >
<div class="modal-content max-h-[90vh] overflow-y-auto"  >
        <span id="closeModal" class="absolute top-4 right-4 text-gray-600 text-3xl font-bold cursor-pointer hover:text-gray-900">×</span>
        <h3 class="text-3xl font-bold mb-6 text-center"  >Your Order</h3>
        <div id="cartItemsContainer" class="mb-6"  >
<div class="flex justify-between items-center py-2 border-b border-gray-200"  >
    <div class="flex items-center space-x-4"  >
        <span class="font-bold text-lg"  >Item Name</span>
    </div>
    <div class="flex items-center space-x-2"  >
        <button class="bg-gray-300 text-gray-700 w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm decrease-quantity-btn" data-id="ITEM_ID"  >-</button>
        <span class="text-sm font-semibold"  >1</span>
        <button class="bg-gray-300 text-gray-700 w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm increase-quantity-btn" data-id="ITEM_ID"  >+</button>
    </div>
    <span class="font-semibold text-orange-500"  >PKR 0.00</span>
</div>
            </div>
        <div id="cartEmptyMessage" class="text-center text-gray-500 mb-6"  >Your cart is empty.</div>
        <div class="grid md:grid-cols-2 gap-4 my-4">
    <div>
        <label for="customerName" class="block text-lg font-bold mb-2">Full Name:</label>
        <input type="text" id="customerName" placeholder="Enter your name" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
    </div>
    <div>
        <label for="customerPhone" class="block text-lg font-bold mb-2">Phone Number:</label>
        <input type="tel" id="customerPhone" placeholder="e.g., 03001234567" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500" pattern="03[0-9]{9}" maxlength="11" oninput="this.value = this.value.replace(/[^0-9]/g, '');">
        <p id="phone-warning" class="text-red-500 text-sm mt-1 h-4"></p>
    </div>
</div>
        <div class="my-4"  >
            <label for="deliveryAddress" class="block text-lg font-bold mb-2"  >Delivery Address:</label>
            <input type="text" id="deliveryAddress" placeholder="Enter your full address" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"  >
        </div>

        <div class="my-4"  >
            <label for="additionalComments" class="block text-lg font-bold mb-2"  >Additional Comments:</label>
            <textarea id="additionalComments" placeholder="e.g., 'No onions please' or 'Allergic to nuts'" rows="3" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"  ></textarea>
        </div>
        <div class="flex items-center my-4"  >
            <input type="checkbox" id="addCutlery" class="mr-2 h-5 w-5 text-orange-500 rounded focus:ring-orange-500"  >
            <label for="addCutlery" class="text-lg font-bold"  >Add Cutlery?</label>
        </div>
        <div class="mt-6 pt-4 border-t">
    <label for="coupon-code-input" class="block font-semibold mb-2">Have a discount code?</label>
    <div class="flex items-center space-x-2">
        <input type="text" id="coupon-code-input" placeholder="Enter code here" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 uppercase">
        <button id="apply-coupon-btn" class="bg-gray-800 text-white font-semibold py-2 px-4 rounded-md whitespace-nowrap hover:bg-black transition">Apply</button>
    </div>
    <p id="coupon-feedback" class="text-sm mt-2 h-5"></p> <!-- For success/error messages -->
</div>

        <div id="totals-section" class="mt-4 pt-4 border-t space-y-2">
    <div class="flex justify-between items-center text-lg">
        <span>Subtotal:</span>
        <span id="cart-subtotal">PKR 0.00</span>
    </div>
    <div id="discount-row" class="hidden flex justify-between items-center text-lg text-green-600 font-semibold">
        <span>Discount:</span>
        <span id="cart-discount">- PKR 0.00</span>
    </div>
    <hr id="total-hr" class="hidden">
    <div class="flex justify-between items-center font-bold text-2xl">
        <span>Total:</span>
        <span id="cartTotal" class="text-orange-500">PKR 0.00</span>
    </div>
</div>
        <div class="text-center text-gray-500 mt-4">
    <p>Estimated Delivery Time: <strong>30-45 minutes</strong></p>
    </div>
    <div id="cart-warning-message" class="hidden" style="background-color: #f39c12; color: white; padding: 10px; border-radius: 5px; text-align: center; margin-top: 15px; font-weight: 500;">
</div>
        <div class="mt-8 space-y-4">
    <button id="show-receipt-btn" class="w-full bg-orange-500 text-white font-bold py-3 px-6 rounded-full hover:bg-orange-600 transition shadow-lg text-lg">
        Proceed to Confirmation
    </button>
    <button id="clearCartBtn" class="w-full bg-red-600 text-white font-semibold py-3 px-6 rounded-full hover:bg-red-500 transition">
        Clear Cart
    </button>
</div>
            </div>
            </div>
            <div id="closed-warning-modal" class="modal">
    <div class="modal-content !max-w-md text-center">
        <!-- Optional: Add an icon -->
        <div style="font-size: 4rem; color: #f39c12; margin-bottom: 1rem;">
            <i class="fas fa-exclamation-triangle"></i> <!-- Make sure you have Font Awesome linked -->
        </div>

        <h3 class="text-3xl font-bold mb-4">Restaurant Currently Closed</h3>
        <p class="text-gray-600 mb-6">
            You can still prepare your order, but it will be placed in a queue and sent to the restaurant as soon as they open.
        </p>

        <div class="flex justify-center space-x-4">
            <button id="cancel-queue-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-full hover:bg-gray-300 transition">
                Go Back
            </button>
            <button id="confirm-queue-btn" class="w-full bg-orange-500 text-white font-bold py-3 px-6 rounded-full hover:bg-orange-600 transition shadow-lg">
                Continue Anyway
            </button>
        </div>
    </div>
</div>
 <script>
    // ========= 1. MAIN APP INITIALIZATION =========
    document.addEventListener('DOMContentLoaded', () => {
        // ========= 2. SETUP AND CONFIGURATION =========
        const SUPABASE_URL = 'https://fiuckqvkzcbbufueomff.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpdWNrcXZremNiYnVmdWVvbWZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxOTM0ODAsImV4cCI6MjA3Mzc2OTQ4MH0.ETayy6vn87DyfkpdnNCoO5GCnR2a88H9aqD5aGdoCZ4';
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // [NEW] RESTAURANT CONTACT INFO
        const RESTAURANT_PHONE_NUMBER_WHATSAPP = '923460714042'; // No '+' for wa.me links
        const RESTAURANT_PHONE_NUMBER_CALL_SMS = '+923460714042'; // '+' is needed for tel: and sms: links

        // ========= 3. ELEMENT SELECTORS (MOVED INSIDE FOR SAFETY) =========
        const getEl = (id) => document.getElementById(id);
        const queryAll = (selector) => document.querySelectorAll(selector);
        
        const menuItemsContainer = getEl('menu-items-container');
        const searchBar = getEl('search-bar');
        const noResultsMessage = getEl('no-results-message');
        const sortSelect = getEl('sort-select');
let categoryBtns = queryAll('.category-btn'); 
        const heroOrderButtons = queryAll('.hero-order-btn');

        const cartButton = getEl('cartButton');
        const cartCountSpan = getEl('cartCount');
        const cartModal = getEl('cartModal');
        const closeModalBtn = getEl('closeModal');
        const cartItemsContainer = getEl('cartItemsContainer');
        const cartTotalSpan = getEl('cartTotal');
        const cartEmptyMessage = getEl('cartEmptyMessage');
        const clearCartBtn = getEl('clearCartBtn');
        
        const deliveryAddressInput = getEl('deliveryAddress');
        const addCutleryCheckbox = getEl('addCutlery');
        const additionalCommentsTextarea = getEl('additionalComments');
        const customerNameInput = getEl('customerName');
const customerPhoneInput = getEl('customerPhone');

        const orderTriggerBtns = queryAll('.order-trigger-btn');
        const receiptContainer = getEl('receipt-container');
        const receiptContent = getEl('receipt-content');
        const closeReceiptBtn = getEl('close-receipt-btn');
        const saveReceiptBtn = getEl('save-receipt-btn');
const sendOrderReceiptBtn = getEl('send-order-receipt-btn');
const showReceiptBtn = getEl('show-receipt-btn');
const confirmOrderBtn = getEl('confirm-order-btn');
const cancelOrderBtn = getEl('cancel-order-btn');
const quickViewModal = getEl('quick-view-modal');
const closeQuickViewBtn = getEl('close-quick-view');
const quickViewOptions = getEl('quick-view-options');
const recentOrdersContainer = getEl('recent-orders-container');
const mobileCloseQuickViewBtn = getEl('mobile-close-quick-view');
const congratsModal = getEl('congrats-modal');
const closeCongratsBtn = getEl('close-congrats-btn');
const congratsDeliveryTime = getEl('congrats-delivery-time');
const addonModal = getEl('addon-modal');
const closeAddonModalBtn = getEl('close-addon-modal');
const addonModalTitle = getEl('addon-modal-title');
const addonOptionsContainer = getEl('addon-options-container');
const addonNoThanksBtn = getEl('addon-no-thanks-btn');
const addonAddToCartBtn = getEl('addon-add-to-cart-btn');
const addonTotalPrice = getEl('addon-total-price');
const qvDecreaseQtyBtn = getEl('qv-decrease-qty');
const qvIncreaseQtyBtn = getEl('qv-increase-qty');
const qvQuantitySpan = getEl('qv-quantity');
const qvAddToCartBtn = getEl('qv-add-to-cart-btn');
const couponCodeInput = getEl('coupon-code-input');
const applyCouponBtn = getEl('apply-coupon-btn');
const couponFeedback = getEl('coupon-feedback');
const discountRow = getEl('discount-row');
const cartSubtotal = getEl('cart-subtotal');
const cartDiscount = getEl('cart-discount');
const totalHr = getEl('total-hr');
const statusRibbon = document.getElementById('status-ribbon');
const ribbonText = document.getElementById('ribbon-text');
const closedWarningModal = document.getElementById('closed-warning-modal');
const cancelQueueBtn = document.getElementById('cancel-queue-btn');
const confirmQueueBtn = document.getElementById('confirm-queue-btn');
const specialBanner = getEl('special-banner');
const specialBannerText = getEl('special-banner-text');
        // ========= 4. GLOBAL STATE VARIABLES =========
        let cart = [];
let allMenuItemsData = []; // To hold the raw data
let allMenuItemElements = []; // To hold the HTML elements
let currentCategory = '';
let lastSuccessfulOrderForReceipt = null;
let isSubmitting = false;       
let pizzaOrderInProgress = null;
let appliedCoupon = null;
let isRestaurantOpen = false;
        // ========= 5. CORE FUNCTIONS =========
        async function initApp() {
          const { data, error } = await db
        .from('settings')
        .select('value')
        .eq('key', 'restaurant_status')
        .single();
        
    if (data) {
        updateRibbonUI(data.value.isOpen);
    }
    const { data: specialData, error: specialError } = await db
        .from('settings')
        .select('value')
        .eq('key', 'daily_special')
        .single();
    
    if (specialData) {
        updateSpecialBannerUI(specialData.value);
    }
    listenForStatusChanges();
            loadCart();
            updateCartUI();
            await buildHeroSlider(); 
            setupEventListeners(); 
            setupHeroSlider();
            setupScrollAnimations();
            renderRecentOrders();
            listenForOrderStatusChanges();
            await initMenu(); 
        }
async function buildHeroSlider() {
    const slidesContainer = getEl('slides-container');
    if (!slidesContainer) return;

    try {
        const { data, error } = await db.from('menu_items').select('*').eq('is_featured', true).limit(3);
        if (error) throw error;
        if (!data || data.length === 0) {
            getEl('hero-slider').style.display = 'none';
            return;
        }
        slidesContainer.innerHTML = '';
        data.forEach(item => {
            const slideHTML = `
                <div class="w-full h-full flex-shrink-0 relative">
                    <img src="${item.image_url}" class="w-full h-full object-cover" alt="${item.name}">
                    <div class="absolute inset-0 bg-black bg-opacity-40"></div>
                    <div class="absolute inset-0 flex flex-col justify-center items-center text-center text-white p-4">
                        <h2 class="text-4xl md:text-6xl font-bold mb-4">${item.name}</h2>
                        <p class="text-lg md:text-xl max-w-2xl mb-8">${item.description || ''}</p>
                        <button data-order-id="${item.id}" class="hero-order-btn bg-orange-500 text-white font-semibold py-3 px-8 rounded-full shadow-lg hover:bg-orange-600 transition pulse-btn">
                            Order Now
                        </button>
                    </div>
                </div>
            `;
            slidesContainer.insertAdjacentHTML('beforeend', slideHTML);
        });
        const allHeroButtons = queryAll('.hero-order-btn');
        allHeroButtons.forEach(button => {
            button.addEventListener('click', handleHeroOrderClick);
        });
    } catch (error) {
        console.error('Error building hero slider:', error.message);
        getEl('hero-slider').style.display = 'none';
    }
}
async function applyCoupon() {
    const code = couponCodeInput.value.trim().toUpperCase();
    if (!code) {
        couponFeedback.textContent = 'Please enter a code.';
        couponFeedback.className = 'text-sm mt-2 h-5 text-red-500';
        return;
    }

    // First, let's calculate the current subtotal to check against
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

    const { data: coupon, error } = await db
        .from('coupons')
        .select('*')
        .eq('code', code)
        .single();

    if (error || !coupon) {
        couponFeedback.textContent = 'Invalid coupon code.';
        couponFeedback.className = 'text-sm mt-2 h-5 text-red-500';
        appliedCoupon = null;
    } else if (!coupon.is_active) {
        couponFeedback.textContent = 'This coupon is no longer active.';
        couponFeedback.className = 'text-sm mt-2 h-5 text-red-500';
        appliedCoupon = null;
    } else if (subtotal < coupon.min_cart_value) { // --- THIS IS THE NEW LOGIC ---
        couponFeedback.textContent = `This Coupon requires a minimum spend of PKR ${coupon.min_cart_value}.`;
        couponFeedback.className = 'text-sm mt-2 h-5 text-red-500';
        appliedCoupon = null; // Don't apply the coupon
    } else {
        couponFeedback.textContent = `Success! ${coupon.discount_percent}% discount applied.`;
        couponFeedback.className = 'text-sm mt-2 h-5 text-green-600';
        appliedCoupon = coupon; // Apply the coupon!
    }
    
    updateCartUI();
}
async function initMenu() {
    try {
        await buildCategoryButtons(); // First, create the buttons
        await fetchMenuItems();       // Then, fetch the items
    } catch (error) {
        console.error('Error initializing menu:', error.message);
        menuItemsContainer.innerHTML = `<p class="text-red-400 text-center col-span-full">Could not load the menu system.</p>`;
    }
}
async function buildCategoryButtons() {
    const { data, error } = await db
        .from('categories')
        .select('*')
        .order('display_order'); // Use the display_order to sort the buttons

    if (error) throw error;

    const categoryContainer = document.querySelector('.flex.flex-wrap.justify-center');
    if (!categoryContainer) return;

    categoryContainer.innerHTML = ''; // Clear any hard-coded buttons

    data.forEach(category => {
        const categorySlug = category.name.toLowerCase().replace(/\s+/g, '-'); // e.g., "Side Dishes" -> "side-dishes"
        const buttonHTML = `
            <button class="category-btn bg-white text-red-900 px-4 py-2 rounded-full font-semibold hover:bg-orange-100 hover:text-orange-600 border-2 border-transparent hover:border-orange-500 transition duration-300" data-category="${categorySlug}">
        ${category.name}
    </button>
        `;
        categoryContainer.insertAdjacentHTML('beforeend', buttonHTML);
    });
    categoryBtns = queryAll('.category-btn');
    categoryBtns.forEach(button => button.addEventListener('click', handleCategoryClick));
}
async function fetchMenuItems() {
    const { data, error } = await db.from('menu_items').select('*').eq('is_available', true);
    if (error) {
        noResultsMessage.textContent = 'Could not load menu items.';
        noResultsMessage.classList.remove('hidden');
        throw error;
    }
        allMenuItemsData = data;
    
    menuItemsContainer.innerHTML = '';
        allMenuItemsData.forEach(item => {
        if (item.price_small || item.price_medium || item.price_large || item.price_xl) {
            item.sizes = {};
            if (item.price_small) item.sizes['Small'] = item.price_small;
            if (item.price_medium) item.sizes['Medium'] = item.price_medium;
            if (item.price_large) item.sizes['Large'] = item.price_large;
            if (item.price_xl) item.sizes['Extra Large'] = item.price_xl;
        }
        const cardHTML = createMenuCardHTML(item);
        menuItemsContainer.insertAdjacentHTML('beforeend', cardHTML);
    });
    allMenuItemElements = Array.from(queryAll('.menu-card'));
    
    const firstCategoryButton = document.querySelector('.category-btn');
    if (firstCategoryButton) {
        currentCategory = firstCategoryButton.dataset.category;
        firstCategoryButton.click();
    }
}
function createMenuCardHTML(item) {
    const priceDisplay = item.sizes ? `<span class="text-xl font-bold text-orange-500">From PKR ${Object.values(item.sizes)[0]}</span>` : `<div><span class="text-xl font-bold text-orange-500">PKR ${item.price}</span>${item.original_price ? `<span class="text-gray-500 line-through text-sm ml-2">PKR ${item.original_price}</span>` : ''}</div>`;
    const buttonHTML = item.sizes ? `<button class="w-full bg-orange-500 text-white font-semibold py-2 px-4 mt-4 rounded-full hover:bg-orange-600 transition add-to-cart-btn">Select Size</button>` : `<button class="w-full bg-orange-500 text-white font-semibold py-2 px-4 mt-4 rounded-full hover:bg-orange-600 transition add-to-cart-btn">Add to Cart</button>`;
    
    let sizeSelectorHTML = '';
    if (item.sizes) {
        const sizeChips = Object.keys(item.sizes).map(size => {
            const chipText = (size.toLowerCase() === 'extra large') ? 'XL' : size[0];
            return `<button class="size-chip" data-size="${size}">${chipText}</button>`;
        }).join('');

        sizeSelectorHTML = `
            <div class="size-selector mt-4 px-2 py-4 bg-black rounded-lg">
                <p class="font-bold text-center text-white mb-3">Choose a size:</p>
                <div class="size-chip-container">${sizeChips}</div>
                <div class="size-price-display"></div>
                <button class="add-pizza-btn w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-green-700 transition opacity-50 cursor-not-allowed" disabled>
                    Add to Cart
                </button>
            </div>
        `;
    }
return `<div class="bg-white rounded-lg shadow-md p-6 menu-card flex flex-col" data-category="${item.category ? item.category.toLowerCase().replace(/\s+/g, '-') : ''}" data-id="${item.id}" data-name="${item.name}" data-description="${item.description || ''}" data-image="${item.image_url}" ${item.sizes ? `data-sizes='${JSON.stringify(item.sizes)}'` : ''} ${item.price ? `data-price="${item.price}"` : ''}>
                <img src="${item.image_url}" alt="${item.name}" class="w-full h-60 object-cover rounded-md mb-4" loading="lazy">
            
            <!-- [THE FIX IS HERE] This div will now expand to fill the empty space -->
            <div class="flex flex-col flex-grow">
                <h3 class="text-2xl font-semibold text-gray-800">${item.name}</h3>
                <p class="text-gray-600 mt-2 flex-grow">${item.description || ''}</p>
            </div>
            
            <!-- This content will now be pushed to the bottom -->
            <div class="mt-4">
                ${priceDisplay}
            </div>
            ${buttonHTML}
            ${sizeSelectorHTML}
        </div>`;
}
   // ========= 6. ORDER FINALIZATION AND SUBMISSION =========
function proceedToShowReceipt() {
    const customerName = customerNameInput.value.trim();
    if (!customerName) { showToastNotification("Please enter your name.", 'error'); customerNameInput.focus(); return; }
    const phoneWarning = getEl('phone-warning');
phoneWarning.textContent = ''; 
const customerPhone = customerPhoneInput.value.trim();
const phoneRegex = /^03\d{9}$/;

if (!customerPhone) {
    showToastNotification("Please enter your phone number.", 'error');
    phoneWarning.textContent = 'Phone number is required.';
    customerPhoneInput.focus();
    return;
}

if (!phoneRegex.test(customerPhone)) {
    showToastNotification("Invalid phone number format.", 'error');
    phoneWarning.textContent = 'Format must be 03001234567.';
    customerPhoneInput.focus();
    return;
}
    const address = deliveryAddressInput.value.trim();
    if (!address) { showToastNotification("Please enter a delivery address.", 'error'); deliveryAddressInput.focus(); return; }
        lastSuccessfulOrderForReceipt = {
        cart: JSON.parse(JSON.stringify(cart)),
        total: parseFloat(cartTotalSpan.textContent.replace('PKR ', '')),
        name: customerName, phone: customerPhone, address: address,
        comments: additionalCommentsTextarea.value.trim(), wants_cutlery: addCutleryCheckbox.checked
    };
    receiptContent.innerHTML = generateReceiptContent();
    receiptContainer.classList.remove('hidden');
    cartModal.style.display = 'none';
}
function handleShowReceipt() {
    if (!isRestaurantOpen) {
        closedWarningModal.style.display = 'flex';
        return; 
    }
    if (cart.length === 0) { 
        showToastNotification("Your cart is empty.", 'error'); 
        return; 
    }
    const customerName = customerNameInput.value.trim();
    if (!customerName) { 
        showToastNotification("Please enter your name.", 'error'); 
        customerNameInput.focus(); 
        return; 
    }
    const customerPhone = customerPhoneInput.value.trim();
    const phoneRegex = /^03\d{9}$/;
    if (!phoneRegex.test(customerPhone)) {
        showToastNotification("Please enter a valid phone number (e.g., 03001234567).", 'error');
        customerPhoneInput.focus();
        return;
    }
    const address = deliveryAddressInput.value.trim();
    if (!address) { 
        showToastNotification("Please enter a delivery address.", 'error'); 
        deliveryAddressInput.focus(); 
        return; 
    }
        proceedToShowReceipt();
}
async function handleConfirmOrder() {
    const orderButton = getEl('confirm-order-btn');
    if (!orderButton || !lastSuccessfulOrderForReceipt) return;
    if (orderButton.disabled) return;

    const originalButtonText = orderButton.innerHTML;
    orderButton.innerHTML = 'Placing Order...';
    orderButton.disabled = true;

    try {
        const { success, error, orderId, accessToken } = await submitOrderToSupabase(lastSuccessfulOrderForReceipt, appliedCoupon);

        if (success) {
            // --- ATOMIC STATE UPDATE ---
            saveOrderToHistory(orderId, accessToken);
            cart = [];
            appliedCoupon = null;
            lastSuccessfulOrderForReceipt = null;
            sessionStorage.removeItem('restaurantCart');

            customerNameInput.value = '';
            customerPhoneInput.value = '';
            deliveryAddressInput.value = '';
            additionalCommentsTextarea.value = '';
            couponCodeInput.value = '';
            couponFeedback.textContent = '';
            
            // Step 5: Update the entire UI at once.
            updateCartUI(); 

            // Step 6: Show success feedback to the user.
            triggerConfetti();
            receiptContainer.classList.add('hidden'); 
            showCongratsModal();

        } else {
            // If the order failed, show an error.
            showToastNotification(`Order failed: ${error.message}`, 'error');
        }
    } catch (e) {
        // Catch any unexpected errors during the process.
        console.error("An unexpected error occurred during order confirmation:", e);
        showToastNotification('An unexpected error occurred. Please try again.', 'error');
    } finally {
        // Step 7 (Finally Block): ALWAYS reset the button.
        // This block runs whether the order succeeded or failed.
        orderButton.innerHTML = originalButtonText;
        orderButton.disabled = false;
    }
}
async function submitOrderToSupabase(orderDetails, coupon = null) {
    try {
        const orderPayload = {
            customer_details: { name: orderDetails.name, phone: orderDetails.phone, address: orderDetails.address, comments: orderDetails.comments, wants_cutlery: orderDetails.wants_cutlery },
            items: orderDetails.cart,
            total_price: orderDetails.total,
            status: 'Pending',
            applied_coupon: coupon ? coupon.code : null,
            discount_percent: coupon ? coupon.discount_percent : null
        };
        const { data, error } = await db.from('orders').insert([orderPayload]).select('id, access_token');
        
        if (error) throw error;
                return { success: true, orderId: data[0].id, accessToken: data[0].access_token }; 

    } catch (error) {
        console.error('Supabase insert error:', error.message);
        return { success: false, error: error };
    }
}
function generateReceiptContent() {
    if (!lastSuccessfulOrderForReceipt) return '<p>No order details found.</p>';

    const { cart: orderCart, total, address, comments, name, phone, wants_cutlery } = lastSuccessfulOrderForReceipt;
    
    let receiptHTML = '';
    
    if (name) receiptHTML += `<p class="mb-2"><b>Name:</b> ${name}</p>`;
    if (phone) receiptHTML += `<p class="mb-2"><b>Phone:</b> ${phone}</p>`;
    if (address) receiptHTML += `<p class="mb-4"><b>Address:</b> ${address}</p>`;
    
    receiptHTML += '<hr class="my-4">';
    
    receiptHTML += `
        <ul class="space-y-3 mb-4">
            ${orderCart.map(item => `
                <li class="flex justify-between items-center">
                    <span>${item.quantity}x ${item.name}</span>
                    <span class="font-semibold">PKR ${(item.price * item.quantity).toFixed(2)}</span>
                </li>
            `).join('')}
        </ul>
        <hr class="my-4">
        <div class="flex justify-between font-bold text-xl mb-4">
            <span>Total:</span>
            <span>PKR ${total.toFixed(2)}</span>
        </div>
    `;

    if (comments) receiptHTML += `<p class="mt-4 text-sm text-gray-600"><b>Comments:</b> ${comments}</p>`;
    if (wants_cutlery) receiptHTML += `<p class="mt-2 text-sm text-gray-600"><b>Cutlery Included</b></p>`;

    return receiptHTML;
}
async function saveReceiptAsImage() {
    if (!lastSuccessfulOrderForReceipt) {
        showToastNotification("No order details to save.", 'error');
        return;
    }

    const printContainer = document.createElement('div');
    printContainer.id = 'receipt-print-container';
    
    const { cart: orderCart, total, address, comments, name, phone, wants_cutlery } = lastSuccessfulOrderForReceipt;
    let receiptHTML = `
        <div style="text-align: center; margin-bottom: 2rem;">
            <img src="https://img.freepik.com/premium-vector/burger-logo_1366-144.jpg" alt="Pixel Tales Logo" style="width: 80px; margin: 0 auto;">
            <h2 style="font-size: 1.875rem; font-weight: 700; margin-top: 1rem;">Order Receipt</h2>
            <p style="color: #6b7280;">Thank you for your order!</p>
        </div>
        <hr style="margin-bottom: 1.5rem;">
    `;
    if (name) receiptHTML += `<p style="margin-bottom: 0.5rem;"><b>Name:</b> ${name}</p>`;
    if (phone) receiptHTML += `<p style="margin-bottom: 0.5rem;"><b>Phone:</b> ${phone}</p>`;
    if (address) receiptHTML += `<p style="margin-bottom: 1.5rem;"><b>Address:</b> ${address}</p>`;
    
    receiptHTML += `<h3 style="font-weight: 600; font-size: 1.125rem; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; padding-top: 0.75rem; padding-bottom: 0.75rem; margin-bottom: 1rem;">Order Summary</h3>`;
    
    receiptHTML += `<div style="margin-bottom: 1.5rem;">`;
    orderCart.forEach(item => {
        receiptHTML += `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <span>${item.quantity}x ${item.name}</span>
                <span style="font-weight: 600;">PKR ${(item.price * item.quantity).toFixed(2)}</span>
            </div>
        `;
    });
    receiptHTML += `</div>`;

    receiptHTML += `<hr style="margin-bottom: 1.5rem;">`;
    receiptHTML += `
        <div style="display: flex; justify-content: space-between; font-weight: 700; font-size: 1.5rem; margin-bottom: 1.5rem;">
            <span>Total:</span>
            <span>PKR ${total.toFixed(2)}</span>
        </div>
    `;

    if (comments) receiptHTML += `<p style="margin-top: 1.5rem; font-size: 0.875rem; color: #4b5563;"><b>Comments:</b> ${comments}</p>`;
    if (wants_cutlery) receiptHTML += `<p style="font-size: 0.875rem; color: #4b5563;"><b>Cutlery Included</b></p>`;
    
    printContainer.innerHTML = receiptHTML;
    document.body.appendChild(printContainer);
    try {
        const canvas = await html2canvas(printContainer, { 
            scale: 2, // Higher resolution
            logging: false,
            useCORS: true 
        });
        const link = document.createElement('a');
        link.href = canvas.toDataURL('image/png');
        link.download = `pixel-tales-receipt-${Date.now()}.png`;
        link.click();
    } catch (err) {
        console.error("Error generating receipt image:", err);
        showToastNotification("Could not save receipt image.", 'error');
    } finally {
        document.body.removeChild(printContainer);
    }
}
        
        // ========= 7. EVENT LISTENERS AND HANDLERS =========
        function setupEventListeners() {
    searchBar.addEventListener('input', updateMenuDisplay);
    sortSelect.addEventListener('change', updateMenuDisplay);
    menuItemsContainer.addEventListener('click', handleMenuInteraction);
   
    cartButton.addEventListener('click', () => { 
      const warningMessage = document.getElementById('cart-warning-message');
    if (!isRestaurantOpen) {
        warningMessage.textContent = 'Warning: The restaurant is currently closed. You can prepare your order, but it will only be received when the restaurant opens.';
        warningMessage.classList.remove('hidden');
    } else {
        warningMessage.classList.add('hidden');
    } cartModal.style.display = 'flex'; });
    closeModalBtn.addEventListener('click', () => { cartModal.style.display = 'none'; });
    window.addEventListener('click', (e) => { if (e.target === cartModal) cartModal.style.display = 'none'; });
    clearCartBtn.addEventListener('click', () => { cart = []; updateCartUI(); });
    cartItemsContainer.addEventListener('click', handleCartQuantityChange);
if (quickViewModal) {
        quickViewModal.addEventListener('click', handleQuickViewInteraction);
    const closeModal = () => { quickViewModal.style.display = 'none'; };
    closeQuickViewBtn.addEventListener('click', closeModal);
    if (mobileCloseQuickViewBtn) {
        mobileCloseQuickViewBtn.addEventListener('click', closeModal);
    }
    
    quickViewModal.addEventListener('click', (e) => { 
        if (e.target.id === 'quick-view-modal') {
            closeModal();
        }
    });
}
if (applyCouponBtn) applyCouponBtn.addEventListener('click', applyCoupon);
    if (showReceiptBtn) showReceiptBtn.addEventListener('click', handleShowReceipt);
    if (confirmOrderBtn) confirmOrderBtn.addEventListener('click', handleConfirmOrder);
    if (cancelOrderBtn) {
        cancelOrderBtn.addEventListener('click', () => {
            receiptContainer.classList.add('hidden');
            cartModal.style.display = 'flex';
        });
    }
if (cancelQueueBtn) {
        cancelQueueBtn.addEventListener('click', () => {
            closedWarningModal.style.display = 'none';
        });
    }

    if (confirmQueueBtn) {
        confirmQueueBtn.addEventListener('click', () => {
            closedWarningModal.style.display = 'none';
            
            if (cart.length === 0) { showToastNotification("Your cart is empty.", 'error'); return; }
            const customerName = customerNameInput.value.trim();
            if (!customerName) { showToastNotification("Please enter your name.", 'error'); customerNameInput.focus(); return; }            
            proceedToShowReceipt();
        });
    }
    if (saveReceiptBtn) saveReceiptBtn.addEventListener('click', saveReceiptAsImage);
    if (recentOrdersContainer) recentOrdersContainer.addEventListener('click', handleOrderAgain);
}
if (addonModal) {
    addonModal.addEventListener('click', handleAddonInteraction);

    const closeAddon = () => { addonModal.style.display = 'none'; };
    closeAddonModalBtn.addEventListener('click', closeAddon);
    addonModal.addEventListener('click', (e) => {
        if (e.target.id === 'addon-modal') { closeAddon(); }
    });
}
if (congratsModal) {
    closeCongratsBtn.addEventListener('click', closeCongratsModal);
    congratsModal.addEventListener('click', (e) => {
        if (e.target === congratsModal) { // Allow clicking the background to close
            closeCongratsModal();
        }
    });
}
        function handleCategoryClick(event) {
    currentCategory = event.currentTarget.dataset.category;
        categoryBtns.forEach(btn => { 
        btn.classList.remove('bg-orange-500', 'text-white', 'border-orange-500'); 
        btn.classList.add('bg-white', 'text-red-900', 'border-transparent'); 
    });
        const clickedButton = event.currentTarget;
    clickedButton.classList.remove('bg-white', 'text-red-900', 'border-transparent');
    clickedButton.classList.add('bg-orange-500', 'text-white', 'border-orange-500');
    updateMenuDisplay();
}
function handleMenuInteraction(e) {
    const card = e.target.closest('.menu-card');
    if (!card) return;
    const mainButton = e.target.closest('.add-to-cart-btn');
    const sizeChip = e.target.closest('.size-chip');
    const addPizzaButton = e.target.closest('.add-pizza-btn');
    
    if (addPizzaButton) {
        const finalId = `${card.dataset.id}-${addPizzaButton.dataset.size.toLowerCase()}`;
        const finalName = `${card.dataset.name} - ${addPizzaButton.dataset.size}`;
        addToCart(finalName, parseFloat(addPizzaButton.dataset.price), finalId, addPizzaButton);
        card.querySelector('.size-selector').classList.remove('selector-open');
        return;
    }
    if (sizeChip) {
        const sizeSelector = card.querySelector('.size-selector');
        const priceDisplay = sizeSelector.querySelector('.size-price-display');
        const finalAddButton = sizeSelector.querySelector('.add-pizza-btn');
        const allChips = sizeSelector.querySelectorAll('.size-chip');

        allChips.forEach(chip => chip.classList.remove('selected'));
        sizeChip.classList.add('selected');

        const sizes = JSON.parse(card.dataset.sizes);
        const selectedSizeName = sizeChip.dataset.size;
        const price = sizes[selectedSizeName];
        
        priceDisplay.textContent = `PKR ${price.toFixed(2)}`;
        finalAddButton.classList.remove('opacity-50', 'cursor-not-allowed');
        finalAddButton.disabled = false;
        
        finalAddButton.dataset.size = selectedSizeName;
        finalAddButton.dataset.price = price;
        return;
    }
    if (mainButton) {
        if (card.dataset.sizes) {
            card.querySelector('.size-selector').classList.toggle('selector-open');
        } else {
            addToCart(card.dataset.name, parseFloat(card.dataset.price), card.dataset.id, mainButton);
        }
        return;
    }
    openQuickView(card.dataset.id);
}
    function handleHeroOrderClick(e) {
    const itemId = e.currentTarget.dataset.orderId;
    const itemData = allMenuItemsData.find(item => item.id == itemId);

    if (itemData) {
        if (itemData.sizes) {
            const sizes = itemData.sizes;
            const defaultSize = Object.keys(sizes)[0];
            const price = sizes[defaultSize];
            const finalName = `${itemData.name} - ${defaultSize}`;
            const finalId = `${itemData.id}-${defaultSize.toLowerCase()}`;
            addToCart(finalName, price, finalId);
        } else {
            addToCart(itemData.name, parseFloat(itemData.price), String(itemData.id));
        }
        cartButton.click();
    } else {
        console.error(`Could not find item with ID "${itemId}" in the hero slider.`);
        window.location.href = '#menu';
    }
}
        // ========= 8. HELPER FUNCTIONS =========
function triggerConfetti() {
    const confettiCount = 200;
    const container = document.body;
    const colors = ['#f59e0b', '#ef4444', '#f97316', '#ffffff'];

    for (let i = 0; i < confettiCount; i++) {
        const confettiEl = document.createElement('div');
        confettiEl.classList.add('confetti');

        confettiEl.style.left = `${Math.random() * 100}vw`;
        confettiEl.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confettiEl.style.animationDelay = `${Math.random() * 0.5}s`;
        confettiEl.style.transform = `scale(${Math.random() * 0.75 + 0.5})`;
        
        container.appendChild(confettiEl);
        setTimeout(() => {
            confettiEl.remove();
        }, 4000);
    }
}
function getStatusBadge(status) {
    switch (status) {
        case 'Pending':
            return '<span class="bg-green-100 text-green-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded-full">Pending Confirmation</span>';
        case 'Preparing':
            return '<span class="bg-yellow-100 text-yellow-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded-full">Preparing Your Order</span>';
        case 'Completed':
            return '<span class="bg-gray-100 text-gray-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded-full">Order Completed!</span>';
        default:
            return `<span class="bg-gray-100 text-gray-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded-full">${status}</span>`;
    }
}
function showCongratsModal() {
    if (!congratsModal) return;
    const congratsDeliveryTime = getEl('congrats-delivery-time');
    if (congratsDeliveryTime) {
        congratsDeliveryTime.innerHTML = 'Estimated Delivery: <strong>30-45 minutes</strong>';
    }
    const lottiePlayer = getEl('congrats-animation');
    if (lottiePlayer) {
        lottiePlayer.seek(0);
        lottiePlayer.play();
    }
    
    congratsModal.classList.add('visible');
        setTimeout(() => {
        closeCongratsModal();
    }, 5000);
}
function closeCongratsModal() {
    if (!congratsModal) return;
    
    congratsModal.classList.remove('visible');
}
function saveOrderToHistory(orderId, accessToken) { // <-- Now accepts accessToken
    if (!lastSuccessfulOrderForReceipt) return;
    const pastOrders = JSON.parse(localStorage.getItem('pixelTalesPastOrders')) || [];
        const newOrder = {
        id: orderId,
        accessToken: accessToken, // The secret key for this order
        date: new Date().toLocaleDateString(),
        status: 'Pending',
        cart: lastSuccessfulOrderForReceipt.cart,
        total: lastSuccessfulOrderForReceipt.total
    };

    pastOrders.unshift(newOrder);
    const recentThreeOrders = pastOrders.slice(0, 3);
    localStorage.setItem('pixelTalesPastOrders', JSON.stringify(recentThreeOrders));
    
    renderRecentOrders();
    listenForOrderStatusChanges();
}
function renderRecentOrders() {
    const pastOrders = JSON.parse(localStorage.getItem('pixelTalesPastOrders')) || [];
    const container = getEl('recent-orders-container');

    if (!container) return; 

    if (pastOrders.length === 0) {
        container.innerHTML = '<p class="text-center text-gray-500">You have no recent orders yet!</p>';
    } else {
        container.innerHTML = pastOrders.map((order, index) => {
            const total = order.total || order.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const itemsSummary = order.cart.map(item => `${item.quantity}x ${item.name}`).join(', ');

            return `
                <div class="bg-white p-6 rounded-lg shadow-md flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div class="text-left w-full">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-xl font-bold text-gray-800">Order #${order.id}</h4>
                            <!-- The new live status badge! -->
                            <div id="status-for-order-${order.id}">
                                ${getStatusBadge(order.status)}
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mb-2">${itemsSummary}</p>
                        <p class="text-gray-800 font-semibold mt-2">Total: PKR ${total.toFixed(2)}</p>
                    </div>
                    <button class="order-again-btn bg-orange-500 text-white font-semibold py-2 px-5 rounded-full hover:bg-orange-600 transition w-full sm:w-auto flex-shrink-0" data-order-index="${index}">
                        Order Again
                    </button>
                </div>`;
        }).join('');
    }
}
let orderStatusChannels = []; 

function listenForOrderStatusChanges() {
    const pastOrders = JSON.parse(localStorage.getItem('pixelTalesPastOrders')) || [];
    if (pastOrders.length === 0) return;

    if (orderStatusChannels.length > 0) {
    db.removeChannel(...orderStatusChannels);
    orderStatusChannels = [];
}
    pastOrders.forEach(order => {
        const channel = db.channel(`public:orders:id=eq.${order.id}`)
            .on('postgres_changes', 
                { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'orders',
                    filter: `id=eq.${order.id}` 
                }, 
                (payload) => {
                    const updatedOrder = payload.new;

                    const currentOrders = JSON.parse(localStorage.getItem('pixelTalesPastOrders')) || [];
                    const orderIndex = currentOrders.findIndex(o => o.id === updatedOrder.id);
                    if (orderIndex > -1) {
                        currentOrders[orderIndex].status = updatedOrder.status;
                        localStorage.setItem('pixelTalesPastOrders', JSON.stringify(currentOrders));

                        const statusBadgeContainer = getEl(`status-for-order-${updatedOrder.id}`);
                        if (statusBadgeContainer) {
                            statusBadgeContainer.innerHTML = getStatusBadge(updatedOrder.status);
                        }
                    }
                }
            )
            .subscribe();
        orderStatusChannels.push(channel);
    });
}
function handleOrderAgain(e) {
    const button = e.target.closest('.order-again-btn');
    if (!button) return;

    const orderIndex = parseInt(button.dataset.orderIndex, 10);
    const pastOrders = JSON.parse(localStorage.getItem('pixelTalesPastOrders')) || [];
    
    if (pastOrders[orderIndex]) {
        cart = JSON.parse(JSON.stringify(pastOrders[orderIndex].cart));
        
        updateCartUI(); 
        cartButton.click(); 
        showToastNotification("Previous order added to cart!");
    }
}

        const saveCart = () => sessionStorage.setItem('restaurantCart', JSON.stringify(cart));
        const loadCart = () => { const storedCart = sessionStorage.getItem('restaurantCart'); if (storedCart) cart = JSON.parse(storedCart); };
function addToCart(name, price, id, clickedButton = null, quantity = 1) { 
    const existingItem = cart.find(item => item.id === id); 
    if (existingItem) { 
        existingItem.quantity += quantity;
    } else { 
        cart.push({ id, name, price, quantity: quantity });
    } 
    
    updateCartUI(); 
    showToastNotification(`${quantity}x ${name} added to cart!`);  
    if (clickedButton) {
        const originalText = clickedButton.innerHTML;
                clickedButton.classList.add('btn-success');
        clickedButton.innerHTML = '✓ Added!';
        clickedButton.disabled = true;

        setTimeout(() => {
            clickedButton.classList.remove('btn-success');
            clickedButton.innerHTML = originalText;
            clickedButton.disabled = false;
        }, 2000);
    }
}
function updateCartUI() {
    cartItemsContainer.innerHTML = ''; 
    const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);

    let subtotal = 0;

    if (itemCount === 0) { 
        cartEmptyMessage.style.display = 'block'; 
        clearCartBtn.style.display = 'none'; 
        getEl('show-receipt-btn').classList.add('opacity-50', 'cursor-not-allowed');
        appliedCoupon = null; 
        if(couponCodeInput) couponCodeInput.value = '';
        if(couponFeedback) couponFeedback.textContent = '';

    } else { 
        cartEmptyMessage.style.display = 'none'; 
        clearCartBtn.style.display = 'block'; 
        getEl('show-receipt-btn').classList.remove('opacity-50', 'cursor-not-allowed');
        
        cart.forEach(item => {
            subtotal += item.price * item.quantity;
            
            const itemElement = document.createElement('div');
            itemElement.className = 'flex flex-col sm:flex-row justify-between items-start sm:items-center py-4 border-b border-gray-200'; 
            
            itemElement.innerHTML = `
                <div class="mb-2 sm:mb-0">
                    <span class="font-bold text-lg text-gray-800">${item.name}</span>
                    <p class="text-sm text-gray-500">PKR ${item.price.toFixed(2)} each</p>
                </div>
                <div class="flex items-center justify-between w-full sm:w-auto">
                    <div class="flex items-center space-x-3">
                        <button class="quantity-btn-brand decrease-quantity-btn" data-id="${item.id}">-</button>
                        <span class="text-lg font-semibold w-8 text-center">${item.quantity}</span>
                        <button class="quantity-btn-brand increase-quantity-btn" data-id="${item.id}">+</button>
                    </div>
                    <div class="sm:ml-6 text-right">
                        <span class="font-semibold text-lg text-orange-500">PKR ${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                </div>
            `;
            cartItemsContainer.appendChild(itemElement); 
        }); 
    } 
        let discountAmount = 0;
    let finalTotal = subtotal;

    if (appliedCoupon && subtotal > 0) {
        discountAmount = subtotal * (appliedCoupon.discount_percent / 100);
        finalTotal = subtotal - discountAmount;
        
        discountRow.classList.remove('hidden');
        totalHr.classList.remove('hidden');
        cartDiscount.textContent = `- PKR ${discountAmount.toFixed(2)}`;
    } else {
        discountRow.classList.add('hidden');
        totalHr.classList.add('hidden');
        if (subtotal === 0) {
            appliedCoupon = null;
        }
    }

    cartSubtotal.textContent = `PKR ${subtotal.toFixed(2)}`;
    cartTotalSpan.textContent = `PKR ${finalTotal.toFixed(2)}`; 
    cartCountSpan.textContent = itemCount;     
    saveCart(); 
}
        function handleCartQuantityChange(e) {
    if (e.target.matches('.decrease-quantity-btn, .increase-quantity-btn')) {
        const idFromButton = e.target.dataset.id;

        const itemIndex = cart.findIndex(item => item.id == idFromButton);
        if (itemIndex === -1) {
            console.error("Could not find item in cart with ID:", idFromButton);
            return;
        }

        if (e.target.matches('.increase-quantity-btn')) {
            cart[itemIndex].quantity++;
        } else {
            cart[itemIndex].quantity--;
            if (cart[itemIndex].quantity <= 0) {
                cart.splice(itemIndex, 1);
            }
        }
        updateCartUI();
    }
}
function updateRibbonUI(isOpen) {
    isRestaurantOpen = isOpen;
    const statusRibbon = document.getElementById('status-ribbon');
    const ribbonTextSegments = document.querySelectorAll('.ribbon-text-segment');
    if (!statusRibbon || ribbonTextSegments.length === 0) return;

    let message = '';
    if (isOpen) {
        message = 'We are currently OPEN and accepting orders!';
        statusRibbon.className = 'status-ribbon-container open visible';
    } else {
        message = 'Sorry, we are currently CLOSED.';
        statusRibbon.className = 'status-ribbon-container closed visible';
    }
        ribbonTextSegments.forEach(segment => {
        segment.textContent = message;
    });
    const orderButtons = document.querySelectorAll('.add-to-cart-btn');
    if (isOpen) {
        orderButtons.forEach(button => {
            button.classList.remove('btn-disabled');
            button.textContent = button.dataset.buttonText || 'Order Now';
        });
    } else {
        orderButtons.forEach(button => {
            button.classList.add('btn-disabled');
            button.textContent = 'Currently Closed';
        });
    }
}
function updateSpecialBannerUI(special) {
    if (special && special.isActive && special.message) {
        specialBannerText.textContent = special.message;
        specialBanner.classList.add('visible');
    } else {
        specialBanner.classList.remove('visible');
    }
}
function listenForStatusChanges() {
    db.channel('public:settings')
      .on('postgres_changes', {
          event: 'UPDATE',
          schema: 'public',
          table: 'settings',
          filter: 'key=eq.restaurant_status'
      }, (payload) => {
          const newStatus = payload.new.value.isOpen;
          updateRibbonUI(newStatus);
      })
.on('postgres_changes', {
        event: 'UPDATE',
        schema: 'public',
        table: 'settings',
        filter: 'key=eq.daily_special'
    }, (payload) => {
        const newSpecial = payload.new.value;
        updateSpecialBannerUI(newSpecial);
    })
    .subscribe();
}
function showToastNotification(message, type = 'success') { 
    const div = document.createElement('div'); 
    
    const isError = type === 'error';
    const bgColor = isError ? 'bg-red-600' : 'bg-green-600';
    const icon = isError 
        ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`
        : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
        
    div.className = `fixed bottom-5 right-5 ${bgColor} text-white px-5 py-3 rounded-lg shadow-xl flex items-center space-x-3 opacity-0 transition-all duration-500 transform translate-y-3 z-[150]`; // Increased z-index
    div.innerHTML = `${icon}<span>${message}</span>`; 
    
    document.body.appendChild(div); 
    
    setTimeout(() => { 
        div.style.opacity = '1'; 
        div.style.transform = 'translateY(0)'; 
    }, 10); 
    
    setTimeout(() => { 
        div.style.opacity = '0'; 
        div.style.transform = 'translateY(3px)'; 
        setTimeout(() => div.remove(), 500); 
    }, 3000); 
}
async function openQuickView(itemId) {
    const item = allMenuItemsData.find(i => i.id == itemId);
    if (!item) return;
    const modalTitle = getEl('quick-view-title');
    const modalDescription = getEl('quick-view-description');
    const modalContent = quickViewModal.querySelector('.modal-content');
    modalContent.dataset.itemId = item.id;
    modalContent.dataset.basePrice = item.price || 0;
    modalContent.dataset.itemName = item.name;
    getEl('qv-quantity').textContent = '1';
        if (item.sizes) {
        getEl('qv-regular-image-container').style.display = 'none';
        getEl('qv-main-quantity-controls').style.display = 'none';
        const pizzaHeader = getEl('qv-pizza-image-header');
        pizzaHeader.classList.remove('hidden');
        getEl('qv-pizza-image').src = item.image_url;
        modalTitle.textContent = `Customize Your ${item.name}`;
        modalDescription.textContent = item.description;
    } else {
        getEl('qv-regular-image-container').style.display = 'block';
        getEl('qv-main-quantity-controls').style.display = 'flex';
        getEl('quick-view-image').src = item.image_url;
        getEl('qv-pizza-image-header').classList.add('hidden');
        modalTitle.textContent = item.name;
        modalDescription.textContent = item.description;
    }
    const optionsContainer = getEl('quick-view-options');
    optionsContainer.innerHTML = ''; // Clear previous options
    const { data: allAddons, error } = await db.from('add_ons').select('*');
    if (error || !allAddons) {
        console.error("Could not load addon options:", error);
        optionsContainer.innerHTML = '<p class="text-red-500">Could not load options.</p>';
        return;
    }
    if (item.sizes) {
        buildSizeSelectorUI(item.sizes, item.id);
    }
    const linkedCategories = item.addon_categories || [];
    if (linkedCategories.length > 0) {
        linkedCategories.forEach(categoryName => {
            const optionsForCategory = allAddons.filter(addon => addon.category === categoryName);
            if (optionsForCategory.length > 0) {
                const accordionTitle = categoryName.charAt(0).toUpperCase() + categoryName.slice(1);

                buildAddonAccordionUI(categoryName, `Add Some ${accordionTitle}`, optionsForCategory, false);
            }
        });
    }
    updateQuickViewPrice();
    quickViewModal.style.display = 'flex';
}
async function openRegularItemModal(item) {
    getEl('quick-view-image').src = item.image_url;
    getEl('quick-view-title').textContent = item.name;
    getEl('quick-view-description').textContent = item.description;

    const modalContent = quickViewModal.querySelector('.modal-content');
    modalContent.dataset.itemId = item.id;
    modalContent.dataset.basePrice = item.price || 0;
    modalContent.dataset.itemName = item.name;
    
    const optionsContainer = getEl('quick-view-options');
    optionsContainer.innerHTML = '';
    getEl('qv-quantity').textContent = '1';
    
    const footer = quickViewModal.querySelector('.border-t');
    if (footer) footer.style.display = 'block';

    const { data: allAddons } = await db.from('add_ons').select('*');
    if (!allAddons) { return; }
    
    const addonCategories = item.addon_categories || [];
    if (addonCategories.includes('drinks')) {
        const drinkOptions = allAddons.filter(addon => addon.category === 'drinks');
        buildAddonAccordionUI('drinks', 'Complete With a Drink', drinkOptions);
    }
    if (addonCategories.includes('fries')) {
        const friesOptions = allAddons.filter(addon => addon.category === 'fries');
        buildAddonAccordionUI('fries', "Don't forget the Fries!", friesOptions);
    }
    if (addonCategories.includes('dips')) {
        const dipOptions = allAddons.filter(addon => addon.category === 'dips');
        buildAddonAccordionUI('dips', 'Add Some Dips', dipOptions, true);
    }
    
    updateQuickViewPrice();
    quickViewModal.style.display = 'flex';
}
function handleQuickViewInteraction(event) {
    const target = event.target;
    const addToCartBtn = target.closest('#qv-add-to-cart-btn');
    if (addToCartBtn) {
        const modalContent = quickViewModal.querySelector('.modal-content');
        const itemTitle = modalContent.dataset.itemName;
        const finalPrice = parseFloat(getEl('qv-total-price').textContent.replace('PKR ', ''));
        const finalQuantity = parseInt(qvQuantitySpan.textContent, 10);
        
        let nameParts = [itemTitle]; // Start with the base name in an array

        const selectedSize = quickViewOptions.querySelector('input[name="modal-pizza-size"]:checked');
        if (selectedSize) {
            nameParts = [`${itemTitle} - ${selectedSize.value}`];
        }
        const selectedAddons = quickViewOptions.querySelectorAll('input:checked:not([name="modal-pizza-size"])');
        selectedAddons.forEach(addon => {
            const label = document.querySelector(`label[for="${addon.id}"] span:first-child`);
            if (label) {
                nameParts.push(label.textContent.trim()); // Add each add-on to the array
            }
        });
        
        const finalName = nameParts.join(', ');
        
        const pricePerItem = finalPrice / finalQuantity;
        const uniqueComboId = btoa(finalName); // Use the final name for a truly unique ID

        addToCart(finalName, pricePerItem, uniqueComboId, addToCartBtn, finalQuantity);
        
        setTimeout(() => { quickViewModal.style.display = 'none'; }, 500);
        return;
    }
}
function buildSizeSelectorUI(sizes, itemId) {
    const optionsContainer = getEl('quick-view-options');
    let sizeHTML = `<div class="mb-4"><p class="font-bold text-lg mb-3">Choose a size:</p><div class="size-radio-group">`;
    
    Object.entries(sizes).forEach(([size, price], index) => {
        const uniqueId = `modal-size-${itemId}-${index}`;
        sizeHTML += `<div><input type="radio" id="${uniqueId}" name="modal-pizza-size" value="${size}" data-price="${price}" ${index === 0 ? 'checked' : ''}><label for="${uniqueId}"><span class="font-semibold">${size}</span><span class="text-gray-400 mx-2 flex-grow border-b border-dotted border-gray-400"></span><span>PKR ${price.toFixed(2)}</span></label></div>`;
    });
    sizeHTML += `</div></div>`;
    optionsContainer.insertAdjacentHTML('beforeend', sizeHTML);
}
function buildAddonAccordionUI(category, title, options, allowMultiple = false, target = 'quickview') {
    const container = (target === 'addon') ? addonOptionsContainer : quickViewOptions;
    if (!container || options.length === 0) return;
    
    const inputType = allowMultiple ? 'checkbox' : 'radio';
    let optionsHTML = '';
    if (!allowMultiple) {
        const uniqueId = `addon-${category}-none`;
        optionsHTML += `
            <div class="py-2">
                <input type="radio" id="${uniqueId}" name="addon-${category}" value="none" data-price="0" checked>
                <label for="${uniqueId}" class="flex justify-between items-center w-full cursor-pointer">
                    <span class="font-semibold text-gray-800 text-sm">None</span>
                </label>
            </div>
        `;
    }
    options.forEach((option) => {
        const uniqueId = `addon-${category}-${option.id}`;
        optionsHTML += `
            <div class="py-2">
                <input type="${inputType}" id="${uniqueId}" name="addon-${category}" value="${option.id}" data-price="${option.price}">
                <label for="${uniqueId}" class="flex justify-between items-center w-full cursor-pointer">
                    <span class="font-semibold text-gray-800 text-sm">${option.name}</span>
                    <span class="text-xs font-semibold text-gray-500">+ PKR ${option.price.toFixed(2)}</span>
                </label>
            </div>
        `;
    });
    const accordionHTML = `
        <div class="addon-accordion-card" data-category="${category}">
            <div class="addon-header">
                <span>${title}</span>
                <span class="flex items-center">
                    <span class="optional-text mr-2">(Optional)</span>
                    <svg class="arrow-icon h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </span>
            </div>
            <div class="addon-content size-radio-group">
                ${optionsHTML}
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', accordionHTML);
}
function updateQuickViewPrice() {
    let totalPrice = 0;
    const qvPriceDisplay = getEl('qv-total-price');
    const qvQuantity = parseInt(getEl('qv-quantity').textContent, 10);
    const modalContent = quickViewModal.querySelector('.modal-content');

    const selectedSize = quickViewOptions.querySelector('input[name="modal-pizza-size"]:checked');
    if (selectedSize) {
        totalPrice += parseFloat(selectedSize.dataset.price);
    } else {
        totalPrice += parseFloat(modalContent.dataset.basePrice);
    }
    
    const selectedAddons = quickViewOptions.querySelectorAll('input:checked:not([name="modal-pizza-size"])');
    selectedAddons.forEach(addon => {
        totalPrice += parseFloat(addon.dataset.price);
    });

    totalPrice *= qvQuantity;
    qvPriceDisplay.textContent = `PKR ${totalPrice.toFixed(2)}`;
}
function handleQuickViewInteraction(event) {
    const target = event.target;
    const accordionHeader = target.closest('.addon-header');
    if (accordionHeader) {
        accordionHeader.parentElement.classList.toggle('open');
        return;
    }
    if (target.matches('input[type="radio"], input[type="checkbox"]')) {
        updateQuickViewPrice();
    }
    const decreaseBtn = target.closest('#qv-decrease-qty');
    const increaseBtn = target.closest('#qv-increase-qty');
    if (decreaseBtn || increaseBtn) {
        let currentQty = parseInt(qvQuantitySpan.textContent, 10);
        if (decreaseBtn && currentQty > 1) currentQty--;
        else if (increaseBtn) currentQty++;
        qvQuantitySpan.textContent = currentQty;
        updateQuickViewPrice();
        return;
    }
    const addToCartBtn = target.closest('#qv-add-to-cart-btn');
if (addToCartBtn) {
    const modalContent = quickViewModal.querySelector('.modal-content');
    const itemTitle = modalContent.dataset.itemName;
    const finalPrice = parseFloat(getEl('qv-total-price').textContent.replace('PKR ', ''));
    const finalQuantity = parseInt(qvQuantitySpan.textContent, 10);
    
    let nameParts = [];

    const selectedSize = quickViewOptions.querySelector('input[name="modal-pizza-size"]:checked');
    if (selectedSize) {
        nameParts.push(`${itemTitle} - ${selectedSize.value}`);
    } else {
        nameParts.push(itemTitle);
    }
    const selectedAddons = quickViewOptions.querySelectorAll('input:checked:not([name="modal-pizza-size"])');
    
    selectedAddons.forEach(addon => {
        if (addon.value !== 'none') {
            const label = document.querySelector(`label[for="${addon.id}"] span:first-child`);
            if (label) {
                nameParts.push(label.textContent.trim());
            }
        }
    });
        
        const finalName = nameParts.join(', ');
        
        const pricePerItem = finalPrice / finalQuantity;
        const uniqueComboId = btoa(finalName); // Use the final name for a truly unique ID

        addToCart(finalName, pricePerItem, uniqueComboId, addToCartBtn, finalQuantity);
        
        setTimeout(() => { quickViewModal.style.display = 'none'; }, 500);
        return;
    }
}
        function setupScrollAnimations() { const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('fade-in-up'); observer.unobserve(entry.target); } }); }, { threshold: 0.1 }); queryAll('[data-animation="fade-in-up"]').forEach(section => { section.classList.add('opacity-0'); observer.observe(section); }); }
        function setupHeroSlider() { const slidesContainer = getEl("slides-container"), sliderDotsContainer = getEl("slider-dots"); if (!slidesContainer || !sliderDotsContainer) return; const slides = slidesContainer.children, numSlides = slides.length; let currentSlide = 0, slideInterval; for (let i = 0; i < numSlides; i++) { const dot = document.createElement("button"); dot.className = "w-3 h-3 rounded-full transition-colors duration-300"; dot.setAttribute("aria-label", `Go to slide ${i + 1}`); dot.addEventListener("click", () => { goToSlide(i); resetInterval(); }); sliderDotsContainer.appendChild(dot); } const dots = sliderDotsContainer.children; const goToSlide = (slideIndex) => { slidesContainer.style.transform = `translateX(-${slideIndex * 100}%)`; currentSlide = slideIndex; updateDots(); }; const updateDots = () => { for (let i = 0; i < numSlides; i++) { dots[i].classList.toggle("bg-white", i === currentSlide); dots[i].classList.toggle("bg-white/50", i !== currentSlide); } }; const nextSlide = () => goToSlide((currentSlide + 1) % numSlides); const startInterval = () => slideInterval = setInterval(nextSlide, 5000); const resetInterval = () => { clearInterval(slideInterval); startInterval(); }; goToSlide(0); startInterval(); }    
  function updateMenuDisplay() {
    const searchTerm = searchBar.value.toLowerCase().trim();
    let visibleItemCount = 0;
    
    allMenuItemElements.forEach(card => {
        const categoryMatch = currentCategory === '' || card.dataset.category === currentCategory;
        const name = card.dataset.name.toLowerCase();
        const description = card.dataset.description.toLowerCase();
        const searchMatch = name.includes(searchTerm) || description.includes(searchTerm);
        if ((searchTerm !== '' && searchMatch) || (searchTerm === '' && categoryMatch)) {
            card.classList.remove('hidden');
            visibleItemCount++;
        } else {
            card.classList.add('hidden');
        }
    });

    noResultsMessage.style.display = visibleItemCount === 0 ? 'block' : 'none';
        const sortValue = sortSelect.value;
    if (sortValue !== 'default') {
        let visibleItems = allMenuItemElements.filter(item => !item.classList.contains('hidden'));
        
        visibleItems.sort((elementA, elementB) => {
            const idA = elementA.dataset.id;
            const idB = elementB.dataset.id;

            const itemDataA = allMenuItemsData.find(item => item.id == idA);
            const itemDataB = allMenuItemsData.find(item => item.id == idB);

            if (!itemDataA || !itemDataB) return 0; // Safety check if data is missing
            const priceA = itemDataA.sizes ? Object.values(itemDataA.sizes)[0] : itemDataA.price;
            const priceB = itemDataB.sizes ? Object.values(itemDataB.sizes)[0] : itemDataB.price;

            const numericPriceA = parseFloat(priceA || 0);
            const numericPriceB = parseFloat(priceB || 0);

            return sortValue === 'price-asc' ? numericPriceA - numericPriceB : numericPriceB - numericPriceA;
        });
        visibleItems.forEach(element => menuItemsContainer.appendChild(element));
    }
}
        initApp();
    });
    </script>
<div id="quick-view-modal" class="modal p-0 md:p-4">
    <div class="modal-content !p-0 !max-w-full md:!max-w-4xl h-full md:h-auto md:max-h-[90vh] flex flex-col">
                <button id="close-quick-view" class="absolute top-2 right-6 bg-white rounded-full p-2 border-2 hover:bg-orange-300 border-orange-500 hover:border-orange-500 transition duration-200 z-20">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700 hover:text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        <div class="flex-grow overflow-y-auto">      
            <div id="qv-regular-image-container" class="relative p-4 rounded-lg">
                <img id="quick-view-image" src="" alt="Quick view of menu item" class="w-full h-auto max-h-48 md:max-h-80 object-contain rounded-lg">
            </div>       
            <div class="p-4">
                <div id="qv-pizza-image-header" class="hidden text-center pb-4 mb-4">
                    <img id="qv-pizza-image" src="" alt="Pizza" class="w-full h-auto max-h-48 md:max-h-80 object-contain rounded-lg">
                </div>
                <h3 id="quick-view-title" class="text-2xl md:text-3xl font-bold mb-1"></h3>
                <p id="quick-view-description" class="text-sm text-gray-600 mb-4"></p>
                <div id="qv-main-quantity-controls" class="flex items-center justify-center space-x-4 my-4">
                    <button id="qv-decrease-qty" class="quantity-btn-outline text-2xl">-</button>
                    <span id="qv-quantity" class="text-3xl font-bold w-16 text-center">1</span>
                    <button id="qv-increase-qty" class="quantity-btn-outline text-2xl">+</button>
                </div>
            </div>
            <div id="quick-view-options" class="px-4 pb-4 space-y-3"></div>
        </div>
        <!-- Sticky Footer -->
        <div class="footer-content border-t p-3 flex-shrink-0">
            <button id="qv-add-to-cart-btn" class="w-full bg-orange-500 text-white font-bold py-3 px-6 rounded-full hover:bg-orange-600 transition shadow-lg text-lg flex justify-between items-center">
                <span>Add to Cart</span>
                <span id="qv-total-price" class="font-semibold">PKR 0.00</span>
            </button>
         </div>
    </div>
</div>
<div id="order-confirmation-card" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50"  >
    <div class="bg-white text-gray-800 p-8 rounded-lg shadow-2xl text-center max-w-sm mx-auto transform scale-90 opacity-0 transition-all duration-500 ease-in-out"  >
        <div class="text-green-500 mb-4"  >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"  >
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        </div>
        <h3 class="text-2xl font-bold text-red-900 mb-2"  >Order Placed!</h3>
        <p class="text-gray-600 mb-6"  >Your order has been successfully sent to the restaurant. Thank you!</p>
        <button id="closeOrderCardBtn" class="bg-red-700 text-white font-semibold py-2 px-6 rounded-full hover:bg-red-800 transition duration-300"  >Done</button>
    </div>
</div>
<div id="receipt-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-110 p-4">
    <div class="bg-white rounded-lg shadow-2xl flex flex-col w-full max-w-lg max-h-[90vh]">
                <div class="p-6 border-b">
            <h3 class="text-2xl font-bold text-center">Your Order Receipt</h3>
        </div>
        <div id="receipt-body" class="p-6 overflow-y-auto">
            <div id="receipt-content" class="text-left">
            </div>
        </div>
        <div class="p-6 border-t bg-gray-50">
            <div class="text-center mb-4">
                <p class="text-md text-red-700 font-semibold">
                </p>
            </div>
            <div class="grid grid-cols-2 gap-4">
    <button id="cancel-order-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 px-6 rounded-full hover:bg-gray-300 transition">Go Back</button>
    <button id="confirm-order-btn" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-full hover:bg-green-700 transition">Confirm & Place Order</button>
</div>
<div class="mt-4 text-center">
    <button id="save-receipt-btn" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-full hover:bg-green-700 transition">Download Receipt Image</button>
</div>
        </div>
    </div>
</div>
<div id="congrats-modal" class="modal">
    <div class="modal-content !max-w-sm text-center flex flex-col items-center justify-center p-6">
        <lottie-player 
            id="congrats-animation"
            src="./success.json" 
            background="transparent" 
            speed="1" 
            style="width: 150px; height: 150px;" 
            autoplay>
        </lottie-player>
        
        <h3 class="text-3xl font-bold text-green-600 mb-2 mt-4">Congratulations!</h3>
        <p class="text-gray-600 mb-2">Your order has been submitted successfully.</p>
        <p id="congrats-delivery-time" class="text-gray-800 font-semibold mb-6"></p>
        <button id="close-congrats-btn" class="bg-green-600 text-white font-semibold py-2 px-8 rounded-full hover:bg-green-700 transition duration-300">Done</button>
    </div>
</div>
</body>
</html>
